# GraphQL
## はじめに
先日初めてその単語を聞いたってくらいの理解度だけど、とりあえず書いてみたくなったので砂場として作成

### やること
+ レガシーなデータベース・外部システムを用いるアカウント管理システムを作る
+ 一度普段やっている方法で実装し、そのあと対呼び元との外部結合をGraphQLにして同じ物を作ってみる
+ 事前知識ほとんどなし、とりあえずまず一度やってみる

### やってみたいこと
+ GraphQLを触ってみたい
+ 提供するAPIがどんな感じになって、仕様書提示とか保守がどんな感じになるか知りたい
+ クエリ解析と従来のコードを用いる層の繋ぎがどんな感じになるか知りたい
+ バリデーションがどんな感じになるか知りたい
+ 認証と認可はどんな感じか知りたい
+ キーワードの設定をどんな感じに行うべきかを考えてみたい
+ 公開したいデータ構造と実在するデータ構造は乖離しているはずで、そのねじ曲げをどうするのか知りたい
+ クエリを解析した結果、DBアクセスなら動的SQL組み立てみたいになるのかと思ったが、外部システムへの参照を行わないといけない場合はどうすれば良いのか
  + 要求次第で利用する外部システムが変わったり、参照方法が変わったりする場合、吸収しきれるのか

### なぜやろうとしたか
+ 業務でレガシーなシステムを使ったり直したりしているが、大抵の場合〜〜画面用参照API、とか汎用〜〜詳細参照API、とかが用意されている
  + 相手次第で言葉の呼び方が違うせいでインターフェースに一貫性がない
    + 同じ値を違うキーで結合するのは当然
    + `item_45`みたいな連番キー名も当然
      + 逆に言うとテーブルカラム名がそういう連番で、呼び元に要求するキー名も自分のテーブルのカラム名そのまんま、返却値もほぼテーブルダンプ、というのが実際のところ
  + 汎用部品は誰がどの用途で呼び出しているか全然把握できない
    + ので不要と思われるパラメータを削れないとか、パラメータの追加の要求があると（把握していない）他の呼び元にも影響が出たりする
    + 数百の返却値がある
+ チームの人と[エヴァンス本](https://images-na.ssl-images-amazon.com/images/I/51f7WXHJYCL._SX258_BO1,204,203,200_.jpg)を読んで話をしていた時に、GraphQLというのがあると聞いた
  + 公表された言語と公開ホストサービスの違いってなんだろう、って話
    + 関係者がだれでも入手出来て、安定して運用されている言葉が公表された言語？
    + 特定利用者に対して専用APIを切るのが公開ホストサービス？
+ 専用APIを沢山用意しなくても、公表された言語と任意の参照を行えるクエリの規格だけがインターフェースとして公開されれば良いのではないか、という話の流れになり、GraphQLというのがあると聞いた
+ 汎用参照で得た100の値の中の1つだけを使って別の汎用参照を行い、最終的に2-3の値を得る、みたいな使われ方が多い
  + 好きな様に参照出来れば良いのでは？という話も出た

## プロダクト仕様
先述のアカウント管理システム  
一覧・詳細・登録・権限あたりがあれば何でも良かった

### 単語
+ アカウントは利用者・管理者からなる
+ アカウントの情報として以下がある
  + 名前
  + メールアドレス
  + 役割
  + 成績
  + 加入年月日

単語           | 英名      | 備考        
:--            | :--       | :--         
アカウント     | account   |             
利用者         | user      |             
管理者         | admin     |             
名前           | full-name |             
メールアドレス | e-mail    |             
役割           | role      | user / admin
成績           | record    | S / A / B   
加入年月日     | joined    | yyyy-mm-dd  
一覧           | list      |             
詳細           | detail    |             
参照           | refer     |             
登録           | register  |             
更新           | update    |             

### 公開するデータ構造
+ account
  + account-id
  + full-name
  + e-mail
  + role
    + user / admin
  + record
    + S / A / B
  + joined
    + yyyy-mm-dd

### 実際のデータ構造
現存する置き換えることは出来ないレガシーなテーブルとカラムによるデータ

```
member_id_number
  max_member_id // 発番管理用
riyou_member    // 罪深き汎用テーブル
  primary_key   // 無意味な連番
  item_1        // member_id
  item_2        // name
  item_3        // mail
  item_4        // kanyu_ymd
kanri_member
  primary_key   // 無意味な連番
  item_1        // riyou_member.item_1と合わせて通し番号
  item_2        // name
  item_3        // mail
  item_4        // kanyu_ymd
seiseki
  primary_key   // 無意味な連番
  item_1        // riyou_memberもしくはkanri_memberのitem_1
  item_2        // seiseki
```

多分こんな感じになっているであろうテーブルを持つ外部システムがいて、その外部システムのAPIを呼ぶことでデータの読み書きを行うシステムを作る
そのレガシーな外部システムはテーブルをただそのままインターフェースに漏らしているので、このテーブル単位での書き込みAPIや参照APIが用意されている

### 機能
機能名                         | 権限             | 概要                                                                                       
:--                            | :--              | :--                                                                                        
認証                           | 利用者<br>管理者 | 自身のアカウントIdとパスワードで認証し、トークンを得る<br>これ以外のAPIはトークンで認可する
アカウント詳細参照（利用者用） | 利用者           | アカウントIdでの詳細検索                                                                   
アカウント詳細参照（管理者用） | 管理者           | アカウントIdでの詳細検索<br>成績も参照出来る                                               
アカウント登録                 | 管理者           | 新規登録してアカウントIdを返す                                                             
アカウント更新（利用者用）     | 利用者           | 自身の名前とメールアドレスを更新する                                                       
アカウント更新（管理者用）     | 管理者           | アカウントの情報を更新する<br>役割と成績も更新できる                                       

### 技術
+ Scala
  + 型があって推論してくれるのが良かったけど、基礎読み書きが出来るレベル
+ フレームワークは一切使わない
  + 慣れてないことをいくつも同時にやらないため
+ レイヤー設計
  + Api
    + 認証はここ
  + Service
    + クエリ解析するもの
    + Domainを扱うもの
  + Domain
    + いかなる副作用にも冒されてはならない
    + 他の層へは一切依存してはいけない
    + 認可はここ？
  + Datasource
    + データベースアクセスを行う
    + 外部システム結合を行う
    + 本当は依存性逆転とかしたいけど、面倒なのでDomainのStaticに直接書いてしまうのでこの層は今回はなし
+ Apiと言うけど、サーバ立てるのは面倒そうな気がしたので適当にごまかす
+ DIではなくて依存性逆転のためにDomain層にインターフェースを用意する
+ 初期パスワードとかが面倒になったので、認証は雰囲気だけ
+ ~~Sqlite3~~
  + と思ったけど、全部外部システムということにしちゃう
